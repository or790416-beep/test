<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用電設備檢驗 - 雙櫃檯系統</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { margin: 0; font-family: system-ui, sans-serif; background: #1a1a1a; color: white; display: flex; flex-direction: column; align-items: center; min-height: 100vh; text-align: center; }
        .header { width: 100%; background: #2d2d2d; padding: 15px 0; font-size: 1.5rem; font-weight: bold; color: #ffffff; border-bottom: 3px solid #00ff88; letter-spacing: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .container { width: 100%; max-width: 600px; padding: 20px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .display-board { display: flex; gap: 20px; justify-content: center; margin: 20px 0; }
        .counter-card { flex: 1; background: #262626; padding: 25px 10px; border-radius: 15px; border: 2px solid #444; transition: 0.3s; }
        .active-1 { border-color: #00d4ff !important; box-shadow: 0 0 20px rgba(0, 212, 255, 0.5); }
        .active-2 { border-color: #ff7700 !important; box-shadow: 0 0 20px rgba(255, 119, 0, 0.5); }
        .card-label { font-size: 1.4rem; color: #888; margin-bottom: 10px; font-weight: bold; }
        .big-number { font-size: 100px; font-weight: 900; line-height: 1; margin: 15px 0; }
        .c1-text { color: #00d4ff; }
        .c2-text { color: #ff7700; }
        #status-text { font-size: 1.8rem; color: #ffcc00; font-weight: bold; margin-top: 20px; min-height: 2.5rem; text-shadow: 0 0 8px rgba(255, 204, 0, 0.5); }
        .admin-panel { margin-top: 30px; padding: 20px; border-top: 1px solid #333; display: none; background: #222; border-radius: 15px; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        button { border: none; padding: 15px; font-size: 1.1rem; font-weight: bold; border-radius: 10px; cursor: pointer; width: 100%; transition: 0.2s; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        button:active { transform: scale(0.95); }
        .btn-c1 { background: #00d4ff; color: #000; }
        .btn-c2 { background: #ff7700; color: #000; }
        .manual-area { margin-top: 5px; padding: 15px; background: #333; border-radius: 10px; }
        input { background: #1a1a1a; border: 1px solid #555; color: #00ff88; padding: 12px; width: 120px; text-align: center; border-radius: 5px; font-size: 1.2rem; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">用電設備檢驗</div>

    <div class="container">
        <div class="display-board">
            <div id="card-1" class="counter-card">
                <div class="card-label">1 號櫃檯</div>
                <div id="num-c1" class="big-number c1-text">--</div>
            </div>
            <div id="card-2" class="counter-card">
                <div class="card-label">2 號櫃檯</div>
                <div id="num-c2" class="big-number c2-text">--</div>
            </div>
        </div>
        <div id="status-text">歡迎光臨</div>

        <div id="admin-box" class="admin-panel">
            <div class="manual-area">
                <label style="display:block; font-size:0.8rem; color:#aaa; margin-bottom:8px;">指定下一號（留空則自動+1）：</label>
                <input type="number" id="manual-num" placeholder="下一號">
            </div>
            <div style="margin-top: 15px;" class="btn-group">
                <button id="btn-call-1" onclick="takeNext(1)" class="btn-c1">1號櫃檯 呼叫</button>
                <button id="btn-call-2" onclick="takeNext(2)" class="btn-c2">2號櫃檯 呼叫</button>
            </div>
            <div class="btn-group">
                <button onclick="reSpeak(1)" style="background: #444; color: #00d4ff; font-size: 0.9rem;">1號重播</button>
                <button onclick="reSpeak(2)" style="background: #444; color: #ff7700; font-size: 0.9rem;">2號重播</button>
            </div>
        </div>
        <p style="font-size: 0.8rem; color: #444; margin-top: 20px;" id="mode-text">客人模式</p>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://onlinenumber-d0369-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        const globalNumRef = db.ref('currentNumber'); 
        const c1Ref = db.ref('c1_last'); 
        const c2Ref = db.ref('c2_last'); 
        const lastRef = db.ref('lastCalled'); 

        c1Ref.on('value', (s) => { document.getElementById('num-c1').innerText = s.val() || 0; });
        c2Ref.on('value', (s) => { document.getElementById('num-c2').innerText = s.val() || 0; });
        lastRef.on('value', (s) => {
            const side = s.val();
            const textEl = document.getElementById('status-text');
            if (side) {
                textEl.innerText = `請至 ${side} 號櫃檯辦理`;
                textEl.style.color = (side == 1) ? "#00d4ff" : "#ff7700";
                document.getElementById('card-1').classList.toggle('active-1', side == 1);
                document.getElementById('card-2').classList.toggle('active-2', side == 2);
            }
        });

        // --- 防重機制變數 ---
        let isProcessing = false;
        let lastClickTime = 0;

        async function takeNext(counterNum) {
            const now = Date.now();
            // 第一重：防時間戳連點 (1秒內不准按第二次)
            if (isProcessing || (now - lastClickTime < 1000)) return;
            
            isProcessing = true;
            lastClickTime = now;
            
            // 第二重：實體禁用按鈕
            const b1 = document.getElementById('btn-call-1');
            const b2 = document.getElementById('btn-call-2');
            b1.disabled = true; b2.disabled = true;

            window.speechSynthesis.cancel();
            
            const manualInput = document.getElementById('manual-num');
            const targetNum = parseInt(manualInput.value);

            try {
                if (!isNaN(targetNum)) {
                    // 情境：指定跳號
                    await globalNumRef.set(targetNum);
                    await updateCounterData(counterNum, targetNum);
                    manualInput.value = '';
                } else {
                    // 情境：自動累加
                    // 使用 once 確保只抓一次當前值，減少 transaction 的重複嘗試
                    const snapshot = await globalNumRef.once('value');
                    const nextNum = (snapshot.val() || 0) + 1;
                    
                    await globalNumRef.set(nextNum);
                    await updateCounterData(counterNum, nextNum);
                }
            } catch (err) {
                console.error("更新失敗:", err);
            } finally {
                // 解鎖按鈕
                setTimeout(() => {
                    isProcessing = false;
                    b1.disabled = false;
                    b2.disabled = false;
                }, 1000);
            }
        }

        async function updateCounterData(counterNum, num) {
            const ref = (counterNum === 1) ? c1Ref : c2Ref;
            await ref.set(num);
            await lastRef.set(counterNum);
            
            // 語音播放
            setTimeout(() => {
                speak(num, counterNum);
            }, 50);
        }

        function reSpeak(counterNum) {
            const num = document.getElementById('num-c' + counterNum).innerText;
            if (num !== "--") {
                speak(num, counterNum);
                lastRef.set(counterNum);
            }
        }

        function speak(number, counter) {
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(`${number} 號，請至 ${counter} 號櫃檯辦理`);
            msg.lang = 'zh-TW';
            msg.rate = 0.9;
            window.speechSynthesis.speak(msg);
        }

        if (new URLSearchParams(window.location.search).get('admin')) {
            document.getElementById('admin-box').style.display = 'block';
            document.getElementById('mode-text').innerText = '管理員模式';
        }
    </script>
</body>
</html>

